---
title: "Data preparation"
author: "Victor Maus"
date: "11/6/2020"
output: html_document
---

```{r setup, include=FALSE}
library(magrittr)
library(parallel)
library(ggplot2)
library(dplyr)
library(sf)
knitr::opts_chunk$set(echo = TRUE)
```

```{r define-commodities-groups, echo=FALSE}
commodities_tbl <- tibble::tibble(commodity_list = c("Antimony", "Bauxite", "Chromite", "Coal", "Copper", "Copper,Cobalt", "Copper,Gold", "Copper,Gold,Molybdenum", "Copper,Gold,Molybdenum,Silver", "Copper,Gold,Silver", "Copper,Gold,Silver,Molybdenum", "Copper,Gold,U3O8", "Copper,Molybdenum", "Copper,Molybdenum,Gold", "Copper,Molybdenum,Gold,Silver", "Copper,Nickel", "Copper,Silver", "Copper,Silver,Gold", "Copper,Zinc", "Copper,Zinc,Gold,Silver", "Copper,Zinc,Lead", "Copper,Zinc,Lead,Gold,Silver", "Copper,Zinc,Lead,Silver", "Copper,Zinc,Lead,Silver,Gold", "Copper,Zinc,Silver,Gold", "Diamonds", "Gold", "Gold,Copper", "Gold,Copper,Molybdenum", "Gold,Copper,Silver", "Gold,Copper,Zinc", "Gold,Copper,Zinc,Lead", "Gold,Copper,Zinc,Lead,Silver", "Gold,Diamonds", "Gold,Nickel", "Gold,Silver", "Gold,Silver,Copper", "Gold,Silver,Copper,Lead,Zinc", "Gold,Silver,Copper,Zinc", "Gold,Silver,Copper,Zinc,Lead", "Gold,Silver,Lead", "Gold,Silver,Lead,Zinc", "Gold,Silver,Lead,Zinc,Copper", "Gold,Silver,Zinc,Lead", "Gold,U3O8", "Graphite", "Ilmenite,Rutile,Zircon,Heavy Mineral Sands", "Iron Ore", "Iron Ore,Magnetite", "Iron Ore,Manganese", "Lanthanides", "Lead,Zinc", "Lead,Zinc,Silver", "Lithium", "Manganese", "Molybdenum", "Molybdenum,Copper", "Nickel", "Nickel,Cobalt", "Nickel,Copper", "Nickel,Copper,Cobalt", "Nickel,Copper,Platinum,Palladium,Rhodium", "Nickel,Gold", "Phosphate", "Platinum,Palladium", "Platinum,Palladium,Rhodium", "Potash", "Potash,Potassium Oxide", "Silver", "Silver,Gold", "Silver,Gold,Lead,Zinc", "Silver,Lead,Zinc", "Silver,Lead,Zinc,Gold", "Silver,Zinc,Lead", "Tantalum", "Tin", "Tungsten", "U3O8", "U3O8,Gold", "U3O8,Vanadium", "Zinc", "Zinc,Copper", "Zinc,Lead", "Zinc,Lead,Copper,Silver", "Zinc,Lead,Copper,Silver,Gold", "Zinc,Lead,Silver", "Zinc,Lead,Silver,Copper"), 
w = c(0.00125199972177784, 0.00765110941086458, 0.00410377686582736, 0.179488071224873, 0.0281004381999026, 0.00337344369479029, 0.02768310495931, 0.00361688808513598, 0.00107811087153092, 0.0101898866244696, 0.00184322181261738, 0.00121722195172846, 0.00726855394032135, 0.00253877721360506, 0.0020171106628643, 0.00139111080197538, 0.00518188773735828, 0.00243444390345691, 0.00368644362523475, 0.0022257772831606, 0.00208666620296307, 0.00219099951311122, 0.00159977742227168, 0.00142588857202476, 0.00139111080197538, 0.0483411003686444, 0.291159490853447, 0.0190582179870627, 0.00121722195172846, 0.0069207762398275, 0.00135633303192599, 0.00295611045419768, 0.0020171106628643, 0.00121722195172846, 0.00177366627251861, 0.0628086527091883, 0.00845099812200042, 0.00198233289281491, 0.00139111080197538, 0.00208666620296307, 0.0011128886415803, 0.00285177714404952, 0.0011128886415803, 0.00128677749182722, 0.00184322181261738, 0.00914655352298811, 0.00215622174306183, 0.0472282117270641, 0.00546010989775336, 0.00142588857202476, 0.00577310982819782, 0.00239966613340753, 0.00215622174306183, 0.00775544272101273, 0.00556444320790151, 0.00472977672671628, 0.00125199972177784, 0.00859010920219795, 0.0046949989566669, 0.00459066564651875, 0.00260833275370383, 0.00170411073241984, 0.00114766641162969, 0.00740766502051888, 0.00114766641162969, 0.00215622174306183, 0.00396466578562983, 0.00184322181261738, 0.00622522083883981, 0.00852055366209919, 0.00128677749182722, 0.00260833275370383, 0.00121722195172846, 0.00146066634207415, 0.00125199972177784, 0.00382555470543229, 0.00233011059330876, 0.0462892119357307, 0.0011128886415803, 0.00236488836335814, 0.00264311052375322, 0.00118244418167907, 0.00657299853933366, 0.0011128886415803, 0.00114766641162969, 0.00674688738958058, 0.00121722195172846))
```


## Global mining areas

For mining areas we use the mining polygons data set available from [10.1594/PANGAEA.910894](https://doi.org/10.1594/PANGAEA.910894). This data set is described here [10.1038/s41597-020-00624-w](https://doi.org/10.1038/s41597-020-00624-w). The polygons cover the entire globe. 
```{r get-mining-polygons}
raw_data_path <- here::here('analysis', 'data', 'raw_data')
derived_data_path <- here::here('analysis', 'data', 'derived_data')

pg_record <- pangaear::pg_data(doi = "10.1594/PANGAEA.910894", overwrite = TRUE, mssgs = TRUE)
unzip(zipfile = pg_record[[1]]$path, 
      files = "global_mining_polygons_v1.gpkg", 
      overwrite = TRUE, 
      exdir = derived_data_path)

mining_pol <- sf::st_read(
  dsn = stringr::str_glue("{derived_data_path}/global_mining_polygons_v1.gpkg"),
  fid_column_name = "FID",
  stringsAsFactors = FALSE,
  query = "SELECT geom, ISO3_CODE, AREA FROM mining_polygons") 

mining_pol %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(ISO3_CODE) %>% 
  dplyr::summarise(AREA = sum(AREA, na.rm = TRUE)) %>% 
  dplyr::arrange(dplyr::desc(AREA)) %>% 
  dplyr::filter(0.95 >= cumsum(AREA)/sum(AREA)) %>% 
  ggplot(aes(x = reorder(ISO3_CODE,desc(AREA)), y = AREA, fill = AREA)) + 
  geom_bar(stat = 'identity') + 
  scale_fill_viridis_c(direction = -1) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  labs(title = 'Countries accounting for 95 % of the mining area', 
       x = 'Country',
       y = 'Area [sqkm]') 
```

## Mining commodities

Information on extracted commodities is often not openly available. Here we simulate a data set of mining commodities and coordinates. 
```{r get-mining-commodities}
mining_com_path <- stringr::str_glue("{derived_data_path}/mining_commodities.gpkg")
if (!file.exists(mining_com_path)){
  set.seed(1986)
  n_samples <- 200
  com_list <- sample(nrow(commodities_tbl), 
                     n_samples, 
                     prob = commodities_tbl$w, 
                     replace = TRUE)
  dplyr::filter(mining_pol, ISO3_CODE %in% c("IDN", "CHL")) %>% 
    sf::st_transform(crs = "+proj=aeqd") %>% 
    dplyr::group_by(ISO3_CODE) %>% 
    dplyr::summarise() %>% 
    sf::st_buffer(units::set_units(4, km)) %>% 
    sf::st_sample(size = n_samples, 
                  type = "random",
                  exact = TRUE,
                  warn_if_not_integer = TRUE,
                  by_polygon = FALSE) %>% 
    sf::st_cast("POINT") %>% 
    sf::st_sf() %>% 
    sf::st_transform(x, crs = sf::st_crs(mining_pol)) %>% 
    sf::st_join(y = dplyr::select(mining_pol, "COUNTRY_NAME", "ISO3_CODE"), 
                left = TRUE, join = sf::st_nearest_feature) %>% 
    dplyr::mutate(COMMODITES = commodities_tbl$commodity_list[com_list]) %>% 
    sf::st_write(mining_com_path, delete_dsn = TRUE)
}

mining_com <- sf::st_read(
  dsn = mining_com_path,
  fid_column_name = "FID",
  stringsAsFactors = FALSE,
  query = "SELECT geom, COUNTRY_NAME, ISO3_CODE FROM mining_commodities") 

mining_com
```

